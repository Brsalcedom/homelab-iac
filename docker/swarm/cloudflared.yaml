version: "3.8"

services:

  cloudflared:
    image: 'cloudflare/cloudflared:latest'
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    deploy:
      replicas: 1
      placement:
        constraints:
          - "node.role==worker"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
